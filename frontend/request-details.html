<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Details - KampungConnect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/header.css">
    <script src="js/config.js"></script>
    <style>
        .welcome-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .detail-card {
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .detail-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            border: none;
        }

        .info-row {
            padding: 1rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: #212529;
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .category-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-right: 1rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 500;
        }

        .response-item {
            border-left: 3px solid #667eea;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .response-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
        }

        .timeline-item {
            position: relative;
            padding-left: 2rem;
            padding-bottom: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 2px;
            height: 100%;
            background: #e9ecef;
        }

        .timeline-dot {
            position: absolute;
            left: -6px;
            top: 5px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #e9ecef;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Base response */
        .response-item {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            margin-left: var(--indent, 0px);
            position: relative;
        }

        /* Remove strong colored borders */
        .response-item.senior,
        .response-item.helper {
            border-left: none;
        }

        /* Add faint dotted vertical guides */
        .response-item::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 0;
            bottom: 0;
            width: 2px;
            border-left: 2px dotted #dee2e6;
        }

        /* Hide guide for root comments */
        .response-item.depth-0::before {
            display: none;
        }

        /* Hover effect like Reddit */
        .response-item:hover {
            background: #f8f9fa;
        }

        .clickable-name {
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .clickable-name:hover {
            color: #667eea;
            text-decoration-style: solid;
        }

        .offer-card-clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .offer-card-clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: #f8f9fa;
        }

        .stat-item {
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
    </style>
</head>

<body>
    <!-- Common Header will be loaded here -->
    <div id="commonHeader"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading request details...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="page-header">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-2">
                            <i class="fas fa-file-alt me-2"></i>Request Details
                        </h2>
                        <p class="mb-0 opacity-75">View complete request information</p>
                    </div>
                    <button onclick="history.back()" class="btn btn-light">
                        <i class="fas fa-arrow-left me-2"></i>Back
                    </button>
                </div>
            </div>
        </div>
        <br>
        <!-- Request Overview Card -->
        <div class="card detail-card">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>Request Overview
            </div>
            <div class="card-body">
                <div class="d-flex align-items-start mb-4">
                    <div id="categoryIconContainer" class="category-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h3 class="mb-0" id="title">Loading...</h3>
                            <span class="badge bg-secondary" id="posterName">#0</span>
                        </div>
                        <div class="mt-2">
                            <span id="categoryBadge" class="category-badge me-2">
                                <i class="fas fa-tag me-1"></i>Category
                            </span>
                            <span id="urgencyBadge" class="badge bg-info">
                                <i class="fas fa-exclamation-circle me-1"></i>Urgency
                            </span>

                        </div>
                    </div>
                </div>
                <div class="stats-badge">
                    <i class="fas fa-reply text-success me-1"></i>
                    Loading offers...
                </div>

                <div class="info-row">
                    <div class="info-label">
                        <i class="fas fa-align-left me-2 text-primary"></i>Description
                    </div>
                    <div class="info-value" id="description">Loading description...</div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">
                                <i class="fas fa-circle me-2 text-primary"></i>Status
                            </div>
                            <div class="info-value">
                                <span id="statusBadge" class="status-indicator">
                                    <i class="fas fa-clock me-2"></i>Loading...
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">
                                <i class="far fa-calendar me-2 text-primary"></i>Created
                            </div>
                            <div class="info-value" id="createdAt">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fulfillment Information -->
        <div class="card detail-card" id="fulfillmentCard" style="display: none;">
            <div class="card-header">
                <i class="fas fa-check-circle me-2"></i>Fulfillment Information
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">
                                <i class="fas fa-user-check me-2 text-success"></i>Fulfilled By
                            </div>
                            <div class="info-value" id="fulfilledBy">—</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">
                                <i class="far fa-clock me-2 text-success"></i>Fulfilled At
                            </div>
                            <div class="info-value" id="fulfilledAt">—</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card detail-card">
            <div class="card-body">
                <h6 class="mb-3"><i class="fas fa-tasks me-2"></i>Actions</h6>
                <div class="action-buttons">

                </div>
            </div>
        </div>

        <!-- Offers Section (Visible only for seniors who created the request) -->
        <div class="card detail-card" id="offersCard" style="display: none;">
            <div class="card-header">
                <i class="fas fa-hands-helping me-2"></i>Offers Received
            </div>
            <div class="card-body" id="offersList">
                <p class="text-muted mb-0">No offers yet.</p>
            </div>
        </div>

        <!-- Contact Info Section (Visible only if request is matched and accepted) -->
        <div class="card detail-card" id="contactInfoCard" style="display: none;">
            <div class="card-header">
                <i class="fas fa-phone me-2"></i>Contact Information
            </div>
            <div class="card-body">
                <p><strong>Helper:</strong> <span id="helperContact"></span></p>
                <p><strong>Senior:</strong> <span id="seniorContact"></span></p>
            </div>
        </div>

        <!-- Responses Section -->
        <div class="card detail-card">
            <div class="card-header">
                <i class="fas fa-comments me-2"></i>Community Responses
            </div>
            <div class="card-body">
                <div id="responsesList">

                </div>
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="card detail-card">
            <div class="card-header">
                <i class="fas fa-history me-2"></i>Activity Timeline
            </div>
            <div class="card-body">
                <div id="timeline">
                    <!-- Timeline will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Helper Stats Modal -->
    <div class="modal fade" id="helperStatsModal" tabindex="-1" aria-labelledby="helperStatsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helperStatsModalLabel">
                        <i class="fas fa-chart-line me-2"></i>Helper Statistics
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="helperStatsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="acceptOfferFromModal" style="display: none;">
                        <i class="fas fa-check me-1"></i>Accept This Helper
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Senior Stats Modal -->
    <div class="modal fade" id="seniorStatsModal" tabindex="-1" aria-labelledby="seniorStatsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="seniorStatsModalLabel">
                        <i class="fas fa-chart-line me-2"></i>Senior Statistics
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="seniorStatsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script src="js/header.js"></script>
    <script>
        async function offerToHelp() {
            const confirmOffer = confirm("Are you sure you want to offer help for this request?");
            if (!confirmOffer) return;

            try {
                const authManager = await waitForAuthManager();
                const params = new URLSearchParams(window.location.search);
                const requestId = params.get("id");

                const response = await authManager.authenticatedFetch(
                    `${window.API_BASE.REQUEST_SERVICE}/requests/${requestId}/offer`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                    }
                );

                const data = await response.json();

                if (response.ok) {
                    alert("Offer submitted successfully!");
                    console.log("Offer:", data.offer);
                    location.reload(); // refresh to show updated status or offers count
                } else {
                    alert(`${data.error || "Failed to offer help."}`);
                }
            } catch (err) {
                console.error("Offer help error:", err);
                alert("Error submitting offer. Please try again later.");
            }
        }

        let currentUser = null;
        let currentRequest = null;

        function waitForAuthManager() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                function check() {
                    attempts++;
                    if (window.AuthManager && typeof window.AuthManager.initialize === 'function') {
                        resolve(window.AuthManager);
                    } else if (attempts >= maxAttempts) {
                        reject(new Error("AuthManager not available"));
                    } else {
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }

        // Get category icon and color
        function getCategoryInfo(category) {
            const categories = {
                'Household': { icon: 'fa-home', color: '#28a745', bg: '#28a74520' },
                'Shopping': { icon: 'fa-shopping-cart', color: '#007bff', bg: '#007bff20' },
                'Transportation': { icon: 'fa-car', color: '#6f42c1', bg: '#6f42c120' },
                'Medical': { icon: 'fa-medkit', color: '#dc3545', bg: '#dc354520' },
                'Technology': { icon: 'fa-laptop', color: '#17a2b8', bg: '#17a2b820' },
                'Social': { icon: 'fa-users', color: '#fd7e14', bg: '#fd7e1420' },
                'Other': { icon: 'fa-ellipsis-h', color: '#6c757d', bg: '#6c757d20' }
            };
            return categories[category] || categories['Other'];
        }

        // Populate user information
        function populateUserInfo(user) {
            if (!user) return;

            // Create display name from firstname and lastname, fallback to email
            const displayName = user.firstname && user.lastname
                ? `${user.firstname} ${user.lastname}`
                : user.firstname || user.email || 'User';

            // Update navigation - check if elements exist first
            const userNameEl = document.getElementById('userName');
            const avatar = document.getElementById('userAvatar');
            
            if (userNameEl) {
                userNameEl.textContent = displayName;
            }
            
            if (avatar) {
                avatar.src = user.picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=6c757d&color=fff`;
                avatar.alt = displayName;
            }
        }

        // Populate request details
        function populateRequestDetails(req) {
            currentRequest = req;

            // Basic info
            document.getElementById('posterName').innerHTML = `Posted by <br><br><span class="clickable-name" onclick="viewSeniorStats(${req.user_id}, '${req.requester_name}')">${req.requester_name}</span> (${req.requester_role})`;
            document.getElementById('title').textContent = req.title.charAt(0).toUpperCase() + req.title.slice(1);
            document.getElementById('description').textContent = req.description;
            document.getElementById('createdAt').textContent = new Date(req.created_at).toLocaleString();

            // Category
            const categoryInfo = getCategoryInfo(req.category);
            const categoryIconContainer = document.getElementById('categoryIconContainer');
            categoryIconContainer.innerHTML = `<i class="fas ${categoryInfo.icon}"></i>`;
            categoryIconContainer.style.backgroundColor = categoryInfo.bg;
            categoryIconContainer.querySelector('i').style.color = categoryInfo.color;

            const categoryBadge = document.getElementById('categoryBadge');
            categoryBadge.textContent = req.category;
            categoryBadge.style.backgroundColor = categoryInfo.bg;
            categoryBadge.style.color = categoryInfo.color;

            // Urgency
            const urgencyBadge = document.getElementById('urgencyBadge');
            const urgencyColors = {
                'low': 'info',
                'medium': 'warning',
                'high': 'danger'
            };
            urgencyBadge.className = `badge bg-${urgencyColors[req.urgency] || 'info'}`;
            urgencyBadge.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>${req.urgency}`;

            // Status
            const statusBadge = document.getElementById('statusBadge');

            // Define a mapping of status → color/icon
            const statusMap = {
            pending:  { color: 'secondary', icon: 'clock', label: 'Pending' },
            matched:  { color: 'info',      icon: 'handshake', label: 'Matched' },
            fulfilled:{ color: 'success',   icon: 'check-circle', label: 'Fulfilled' },
            };

            // Fallback for unknown statuses
            const { color, icon, label } = statusMap[req.status] || { 
            color: 'secondary', 
            icon: 'question-circle', 
            label: req.status || 'Unknown' 
            };

            statusBadge.className = `status-indicator bg-${color} text-white`;
            statusBadge.innerHTML = `<i class="fas fa-${icon} me-2"></i>${label}`;


            // Contact info if matched
            if (req.status === 'matched') {

                const isSeniorOwner = (currentUser.role === 'senior' && currentUser.id === req.user_id);
                const isAcceptedHelper = (["volunteer", "caregiver", "admin"].includes(currentUser.role) && currentUser.id === req.helper_id);

                if (isSeniorOwner || isAcceptedHelper) {
                    document.getElementById("contactInfoCard").style.display = "block";

                    document.getElementById("helperContact").textContent =
                        `${req.helper_name} (${req.helper_email || "no email"})`;

                    document.getElementById("seniorContact").textContent =
                        `${req.requester_name} (${req.requester_email || "no email"})`;
                }
            }

            // Fulfillment info
            if (req.fulfilledAt && req.fulfilledBy) {
                document.getElementById('fulfillmentCard').style.display = 'block';
                document.getElementById('fulfilledAt').textContent = new Date(req.fulfilledAt).toLocaleString();
                document.getElementById('fulfilledBy').innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-circle fa-2x me-2 text-success"></i>
                        <div>
                            <strong>${req.fulfilledBy.name}</strong><br>
                            <small class="text-muted">
                                <i class="fas fa-star text-warning"></i> ${req.fulfilledBy.rating || 'N/A'}
                            </small>
                        </div>
                    </div>
                `;
            }

            // Create timeline
            createTimeline(req);
        }

        // Create activity timeline
        async function createTimeline(req) {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';

            const events = [
                {
                    icon: 'fa-plus-circle',
                    color: 'primary',
                    title: 'Request Created',
                    time: req.created_at,
                    description: `Request was posted by ${req.requester_name || 'user'}`
                }
            ];

            // Load offers for timeline
            try {
                const authManager = await waitForAuthManager();
                const offersRes = await authManager.authenticatedFetch(`${window.API_BASE.REQUEST_SERVICE}/requests/${req.id}/offers`);
                const offersData = await offersRes.json();

                if (offersRes.ok && offersData.offers) {
                    offersData.offers.forEach(offer => {
                        events.push({
                            icon: 'fa-handshake',
                            color: 'info',
                            title: 'Offer Received',
                            time: offer.created_at,
                            description: `${offer.helper_name} (${offer.helper_role}) offered help`
                        });

                        if (offer.status === "accepted") {
                            events.push({
                                icon: 'fa-check',
                                color: 'success',
                                title: 'Offer Accepted',
                                time: offer.created_at,
                                description: `Offer from ${offer.helper_name} was accepted`
                            });
                        }
                    });
                }
            } catch (err) {
                console.error("Timeline offers load error:", err);
            }

            if (req.status === "fulfilled") {
                events.push({
                    icon: 'fa-check-circle',
                    color: 'success',
                    title: 'Request Fulfilled',
                    time: '',
                    description: `Request was marked as fulfilled`
                });
            }

            // Sort all events by time
            events.sort((a, b) => new Date(a.time) - new Date(b.time));

            // Render
            events.forEach((event, index) => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                if (index === events.length - 1) {
                    item.style.paddingBottom = '0';
                }
                item.innerHTML = `
                    <div class="timeline-dot" style="background: var(--bs-${event.color});"></div>
                    <div>
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <strong>
                                <i class="fas ${event.icon} me-2 text-${event.color}"></i>
                                ${event.title}
                            </strong>
                            <small class="text-muted">${event.time ? new Date(event.time).toLocaleString() : ''}</small>
                        </div>
                        <p class="text-muted mb-0">${event.description}</p>
                    </div>
                `;
                timeline.appendChild(item);
            });
        }


        function showActionButtons(user) {
            const actions = document.querySelector('.action-buttons');
            actions.innerHTML = ''; // clear

            // senior cant press respond to request button
            let respondBtn;
            if (user.role !== 'volunteer' && user.role !== 'caregiver' && user.role !== 'admin') {
                respondBtn = `
                    <span data-bs-toggle="tooltip" title="Only helpers can respond to requests">
                        <button class="btn btn-success" disabled>
                            <i class="fas fa-reply me-2"></i>Respond to Request
                        </button>
                    </span>
                `;
            } else {
                respondBtn = `
                    <button class="btn btn-success" onclick="respondToRequest()">
                        <i class="fas fa-reply me-2"></i>Respond to Request
                    </button>
                `;
            }

            // Offer to help button (helpers only)
            let offerBtn = '';
            if (["volunteer", "caregiver", "admin"].includes(user.role)) {
                offerBtn = `
        <button class="btn btn-info" onclick="offerToHelp()">
            <i class="fas fa-hands-helping me-2"></i>Offer to Help
        </button>
    `;
            } else {
                offerBtn = `
        <span data-bs-toggle="tooltip" title="Only helpers can offer to help">
            <button class="btn btn-info" disabled>
                <i class="fas fa-hands-helping me-2"></i>Offer to Help
            </button>
        </span>
    `;
            }

            // Other action buttons
            actions.innerHTML = `
                ${respondBtn}
                ${offerBtn}
                <button class="btn btn-primary" onclick="shareRequest()">
                    <i class="fas fa-share-alt me-2"></i>Share
                </button>             
            `;

            // Initialize Bootstrap tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
        }

        async function loadResponses(requestId) {
            try {
                const authManager = await waitForAuthManager();
                const response = await authManager.authenticatedFetch(
                    `${window.API_BASE.REQUEST_SERVICE}/requests/${requestId}/responses`
                );
                const data = await response.json();

                const container = document.getElementById("responsesList");
                container.innerHTML = "";

                if (!response.ok || !data.responses || data.responses.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-inbox fa-2x mb-2 opacity-50"></i>
                            <p>No responses yet. Be the first to help!</p>
                        </div>`;
                    return;
                }

                renderResponses(data.responses);
            } catch (err) {
                console.error("Error loading responses:", err);
            }
        }

        async function loadOffers(requestId, request, user) {
            try {
                const authManager = await waitForAuthManager();
                const response = await authManager.authenticatedFetch(`${window.API_BASE.REQUEST_SERVICE}/requests/${requestId}/offers`);
                const data = await response.json();

                const offersCard = document.getElementById("offersCard");
                const offersList = document.getElementById("offersList");
                offersList.innerHTML = "";

                document.querySelector(".stats-badge").innerHTML = `
                    <i class="fas fa-reply text-success me-1"></i>
                    ${data.offers.length} ${data.offers.length === 1 ? 'Offer' : 'Offers'}
                `;

                if (!response.ok || !data.offers || data.offers.length === 0) {
                    offersList.innerHTML = `<p class="text-muted mb-0">No offers yet.</p>`;
                    return;
                }

                offersCard.style.display = "block";

                data.offers.forEach((offer) => {
                    const offerCard = document.createElement("div");
                    offerCard.classList.add("p-3", "border", "rounded", "mb-2", "bg-light", "offer-card-clickable");
                    const canAccept = request.user_id === user.id && offer.status === "pending";

                    // Add click handler to view helper stats
                    offerCard.addEventListener("click", (e) => {
                        // Don't trigger if clicking the accept button
                        if (!e.target.closest('button')) {
                            viewHelperStats(offer.helper_id, offer.helper_name, offer.id, canAccept);
                        }
                    });

                    let actionHtml = "";
                    if (canAccept) {
                        actionHtml = `
                            <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); acceptOffer(${offer.id})">
                                <i class="fas fa-check me-1"></i>Accept Offer
                            </button>
                        `;
                    } else {
                        actionHtml = `
                            <span class="badge bg-${offer.status === "accepted" ? "success" : "secondary"}">
                                ${offer.status.charAt(0).toUpperCase() + offer.status.slice(1)}
                            </span>
                        `;
                    }

                    offerCard.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${offer.helper_name}</strong> <span style="font-size: 14px;">(${offer.helper_role.charAt(0).toUpperCase() + offer.helper_role.slice(1)})</span><br>
                                <small class="text-muted">${offer.helper_role.charAt(0).toUpperCase() + offer.helper_role.slice(1)}'s Location: ${offer.location || 'Not specified'}</small><br>
                                <small class="text-muted">Rating: ${offer.rating || 'No rating yet'}</small><br>
                                <small class="text-muted">Offered on ${new Date(offer.created_at).toLocaleString()}</small>
                                <br>
                                <small class="text-primary"><i class="fas fa-info-circle me-1"></i>Click to view stats</small>
                            </div>
                            <div>
                                ${actionHtml}
                            </div>
                        </div>
                    `;
                    offersList.appendChild(offerCard);
                });
            } catch (err) {
                console.error("Error loading offers:", err);
            }
        }

        async function acceptOffer(offerId) {
            if (!confirm("Accept this volunteer's help?")) return;

            try {
                const authManager = await waitForAuthManager();
                const response = await authManager.authenticatedFetch(`${window.API_BASE.REQUEST_SERVICE}/offers/${offerId}/accept`, {
                    method: "POST",
                });

                const data = await response.json();

                if (response.ok) {
                    alert("Offer accepted! Helper assigned.");

                    if (data.contact) {
                        showContactInfo(data.contact.helper, data.contact.senior);
                    }

                    // location.reload();
                } else {
                    alert(`${data.error || "Failed to accept offer."}`);
                }
            } catch (err) {
                console.error("Error accepting offer:", err);
                alert("Something went wrong. Please try again.");
            }
        }

        function showContactInfo(helper, senior) {
            document.getElementById("contactInfoCard").style.display = "block";

            document.getElementById("helperContact").textContent =
                `${helper.firstname || helper.name || helper.helper_name || "Unknown"} (${helper.email || "no email"})`;

            document.getElementById("seniorContact").textContent =
                `${senior.firstname || senior.name || senior.requester_name || "Unknown"} (${senior.email || "no email"})`;
        }

        // Action functions
        async function respondToRequest() {
            const message = prompt("Enter your response message:");
            if (!message) return;

            try {
                const authManager = await waitForAuthManager();
                await authManager.initialize();

                const params = new URLSearchParams(window.location.search);
                const requestId = params.get("id");

                const response = await authManager.authenticatedFetch(
                    `${window.API_BASE.REQUEST_SERVICE}/requests/${requestId}/respond`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message })
                    }
                );

                const data = await response.json();
                if (response.ok) {
                    alert("Response submitted successfully!");
                    console.log("Response:", data);
                    location.reload(); // reload to show the new response
                } else {
                    throw new Error(data.error || "Failed to respond");
                }
            } catch (err) {
                console.error("Respond error:", err);
                alert("Error: " + err.message);
            }
        }

        function renderResponses(responses) {
            const container = document.getElementById("responsesList");
            container.innerHTML = '';

            // Build a map of responses by id
            const responseMap = {};
            responses.forEach(r => {
                const id = Number(r.id);
                responseMap[id] = { ...r, id, replies: [] };
            });

            // Link children to parents
            const rootResponses = [];
            responses.forEach(r => {
                const id = Number(r.id);
                const pid = r.parent_id ? Number(r.parent_id) : null;

                if (pid && responseMap[pid]) {
                    responseMap[pid].replies.push(responseMap[id]);
                } else {
                    rootResponses.push(responseMap[id]);
                }
            });

            // Recursive render
            function renderResponse(res, depth = 0, parentEl = container) {
                const item = document.createElement("div");
                const roleClass = res.responder_role || '';
                item.className = `response-item depth-${depth} ${roleClass}`;
                item.style.setProperty('--indent', `${depth * 24}px`);

                // role badge
                let roleBadge = '';
                if (res.responder_role === 'senior') {
                    roleBadge = `<span class="badge bg-primary ms-2">Senior</span>`;
                } else if (res.responder_role === 'helper') {
                    roleBadge = `<span class="badge bg-success ms-2">Helper</span>`;
                }

                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div>
                            <strong class="${res.responder_role === 'senior' ? 'text-primary fw-bold' : ''}">
                                ${res.responder_name || "Anonymous"}
                            </strong>
                            ${roleBadge}
                        </div>
                        <small class="text-muted">${new Date(res.created_at).toLocaleString()}</small>
                    </div>
                    <p class="mb-1">${res.message}</p>
                    <button class="btn btn-sm btn-outline-primary" onclick="replyToResponse(${res.id})">
                        Reply
                    </button>
                `;

                const repliesContainer = document.createElement("div");
                repliesContainer.classList.add("replies");
                item.appendChild(repliesContainer);

                // add this item into the parent
                parentEl.appendChild(item);

                res.replies.forEach(reply => renderResponse(reply, depth + 1, repliesContainer));
            }

            function sortReplies(node) {
                node.replies.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                node.replies.forEach(sortReplies);
            }

            // sort root responses
            rootResponses.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            rootResponses.forEach(sortReplies);

            rootResponses.forEach(r => renderResponse(r));
        }

        async function replyToResponse(responseId) {
            const message = prompt("Enter your reply:");
            if (!message) return;

            try {
                const authManager = await waitForAuthManager();
                const response = await authManager.authenticatedFetch(
                    `${window.API_BASE.REQUEST_SERVICE}/responses/${responseId}/reply`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message })
                    }
                );
                if (response.ok) {
                    location.reload(); // refresh to show new reply
                }
            } catch (err) {
                alert("Failed to reply: " + err.message);
            }
        }


        function shareRequest() {
            if (navigator.share && currentRequest) {
                navigator.share({
                    title: currentRequest.title,
                    text: currentRequest.description,
                    url: window.location.href
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Link copied to clipboard!');
                });
            }
        }

        // Function to view helper stats
        async function viewHelperStats(helperId, helperName, offerId, canAccept) {
            try {
                const modal = new bootstrap.Modal(document.getElementById('helperStatsModal'));
                const modalContent = document.getElementById('helperStatsContent');
                const acceptBtn = document.getElementById('acceptOfferFromModal');

                // Show loading
                modalContent.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading helper statistics...</p>
                    </div>
                `;
                modal.show();

                // Fetch helper stats
                const authManager = await waitForAuthManager();
                const response = await authManager.authenticatedFetch(`${window.API_BASE.STATS_SERVICE}/stats/helper/${helperId}`);

                if (!response.ok) {
                    throw new Error('Failed to load helper stats');
                }

                const stats = await response.json();

                // Build badges html
                let badgesHtml = '';
                if (stats.badges && stats.badges.length > 0) {
                    badgesHtml = `
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="mb-3">
                                    <i class="fas fa-trophy me-2 text-warning"></i>
                                    Badges Earned 
                                    <span class="badge bg-primary ms-2">${stats.badges.length}</span>
                                </h6>
                                <div class="row">
                                    ${stats.badges.map(badge => `
                                        <div class="col-md-4 col-6 mb-3">
                                            <div class="text-center p-2 border rounded" style="background: ${badge.color}10; border-color: ${badge.color}!important;">
                                                <i class="fas ${badge.icon} fa-2x mb-2" style="color: ${badge.color};"></i>
                                                <div class="fw-bold" style="font-size: 0.85rem;">${badge.name}</div>
                                                <small class="text-muted" style="font-size: 0.75rem;">${badge.description}</small>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Display stats
                modalContent.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="mb-3">
                                <i class="fas fa-user-circle me-2"></i>${helperName || 'Helper'}
                            </h5>
                        </div>
                    </div>
                    ${badgesHtml}
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Completed Requests</small>
                                <h4 class="mb-0 text-success">${stats.request_stats.total_completed}</h4>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Completion Rate</small>
                                <h4 class="mb-0 text-primary">${stats.request_stats.completion_rate}</h4>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Average Rating</small>
                                <h4 class="mb-0 text-warning">
                                    <i class="fas fa-star"></i> ${stats.rating_stats.avg_rating}
                                </h4>
                                <small class="text-muted">${stats.rating_stats.total_ratings} ratings</small>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Average Completion Time</small>
                                <h4 class="mb-0">${stats.time_stats.avg_completion_time}</h4>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Response Time</small>
                                <h4 class="mb-0">${stats.performance.avg_response_time}</h4>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Rank</small>
                                <h4 class="mb-0 text-info">${stats.performance.rank}</h4>
                            </div>
                        </div>
                    </div>
                    ${Object.keys(stats.category_breakdown).length > 0 ? `
                        <div class="row">
                            <div class="col-12">
                                <h6 class="mb-2"><i class="fas fa-list me-2"></i>Help by Category</h6>
                                ${Object.entries(stats.category_breakdown).map(([cat, count]) => `
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>${cat}</span>
                                        <span class="badge bg-primary">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                // Show accept button if offer is pending and user can accept
                if (offerId && canAccept) {
                    acceptBtn.style.display = 'block';
                    acceptBtn.onclick = () => {
                        modal.hide();
                        acceptOffer(offerId);
                    };
                } else {
                    acceptBtn.style.display = 'none';
                }

            } catch (err) {
                console.error('Error loading helper stats:', err);
                document.getElementById('helperStatsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load helper statistics. Please try again.
                    </div>
                `;
            }
        }

        // Function to view senior stats
        async function viewSeniorStats(seniorId, seniorName) {
            try {
                const modal = new bootstrap.Modal(document.getElementById('seniorStatsModal'));
                const modalContent = document.getElementById('seniorStatsContent');

                // Show loading
                modalContent.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading senior statistics...</p>
                    </div>
                `;
                modal.show();

                // Fetch senior stats
                const authManager = await waitForAuthManager();
                const response = await authManager.authenticatedFetch(`${window.API_BASE.STATS_SERVICE}/stats/senior/${seniorId}`);

                if (!response.ok) {
                    throw new Error('Failed to load senior stats');
                }
                const stats = await response.json();

                // Display stats
                modalContent.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="mb-3">
                                <i class="fas fa-user-circle me-2"></i>${seniorName || 'Senior'}
                            </h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Total Requests Posted</small>
                                <h4 class="mb-0 text-primary">${stats.request_stats.total_posted}</h4>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Fulfilled Requests</small>
                                <h4 class="mb-0 text-success">${stats.request_stats.total_fulfilled}</h4>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Pending Requests</small>
                                <h4 class="mb-0 text-warning">${stats.request_stats.total_pending}</h4>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Success Rate</small>
                                <h4 class="mb-0 text-info">${stats.request_stats.fulfillment_rate}</h4>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Average Rating Given</small>
                                <h4 class="mb-0 text-warning">
                                    <i class="fas fa-star"></i> ${stats.rating_stats.avg_rating_given}
                                </h4>
                                <small class="text-muted">${stats.rating_stats.total_ratings_given} ratings given</small>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="stat-item">
                                <small class="text-muted d-block">Ongoing Requests</small>
                                <h4 class="mb-0">${stats.request_stats.total_ongoing}</h4>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="mb-2"><i class="fas fa-chart-line me-2"></i>Activity Trends</h6>
                            <div class="stat-item">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>This Month</span>
                                    <span class="badge bg-primary">${stats.trends.requests_this_month}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Last Month</span>
                                    <span class="badge bg-secondary">${stats.trends.requests_last_month}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${stats.category_breakdown.breakdown && Object.keys(stats.category_breakdown.breakdown).length > 0 ? `
                        <div class="row">
                            <div class="col-12">
                                <h6 class="mb-2"><i class="fas fa-list me-2"></i>Requests by Category</h6>
                                <p class="mb-2"><strong>Most Requested:</strong> ${stats.category_breakdown.most_requested}</p>
                                ${Object.entries(stats.category_breakdown.breakdown).map(([cat, count]) => `
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>${cat}</span>
                                        <span class="badge bg-info">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
            } catch (err) {
                console.error('Error loading senior stats:', err);
                document.getElementById('seniorStatsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load senior statistics. Please try again.
                    </div>
                `;
            }
        }

        // function reportRequest() {
        //     if (confirm('Are you sure you want to report this request?')) {
        //         alert('Report feature - This will send a report to moderators');
        //     }
        // }

        // Initialize
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const authManager = await waitForAuthManager();
                await authManager.initialize();

                const isAuthenticated = await authManager.checkAuthentication();
                if (!isAuthenticated) {
                    window.location.href = "login.html";
                    return;
                }

                // Wait for header to load before accessing header elements
                if (window.HeaderManager && typeof window.HeaderManager.waitForLoad === 'function') {
                    await window.HeaderManager.waitForLoad();
                }

                // Get and populate user info
                currentUser = authManager.getCurrentUser();
                populateUserInfo(currentUser);

                showActionButtons(currentUser);
                // Get request ID from URL
                const params = new URLSearchParams(window.location.search);
                const requestId = params.get("id");

                if (!requestId) {
                    throw new Error('No request ID provided');
                }

                // Fetch request details
                const response = await authManager.authenticatedFetch(`${window.API_BASE.REQUEST_SERVICE}/requests/${requestId}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load request');
                }

                populateRequestDetails(data.request);

                // fetch and display responses
                await loadResponses(requestId);

                await loadOffers(requestId, data.request, currentUser);

                if (data.request.user_id === currentUser.id) {
                    document.getElementById("offersCard").style.display = "block";
                }

                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';

                // Logout handler
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        if (confirm('Are you sure you want to logout?')) {
                            await authManager.logout();
                        }
                    });
                }

                if (currentUser.role === "senior") {
                    const myRequestsMenuItem = document.getElementById("myRequestsMenuItem");
                    if (myRequestsMenuItem) {
                        myRequestsMenuItem.style.display = "block";
                    }
                }

            } catch (err) {
                console.error("Error loading request details:", err);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h4>Failed to Load Request</h4>
                        <p class="text-muted">${err.message}</p>
                        <div class="mt-3">
                            <button onclick="history.back()" class="btn btn-secondary me-2">
                                <i class="fas fa-arrow-left me-1"></i>Go Back
                            </button>
                            <a href="dashboard.html" class="btn btn-primary">
                                <i class="fas fa-home me-1"></i>Dashboard
                            </a>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>

</html>