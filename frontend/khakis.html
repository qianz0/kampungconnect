<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Khakis Near Me - KampungConnect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/header.css" rel="stylesheet">
    <style>
        .khaki-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 8px;
            overflow: hidden;
        }

        .khaki-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .khaki-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .rating-stars {
            color: #ffc107;
        }

        .location-badge {
            background-color: #e7f3ff;
            color: #0066cc;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .tab-content {
            padding-top: 20px;
        }

        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            background-color: transparent;
        }

        .nav-tabs .nav-link:hover {
            border-bottom: 3px solid #c5cae9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
        }

        .khaki-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
        }

        .member-since {
            font-size: 0.85rem;
            color: #6c757d;
        }
    </style>
</head>

<body>
    <!-- Common Header will be loaded here -->
    <div id="commonHeader"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading khakis...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-users me-2"></i>View Khakis Near Me</h2>
                        <p class="text-muted">Connect with fellow seniors in your community</p>
                    </div>
                    <div>
                        <span class="badge bg-primary" id="locationBadge">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            <span id="currentLocation">Loading...</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="khakiTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="nearby-tab" data-bs-toggle="tab" 
                                data-bs-target="#nearby" type="button" role="tab" 
                                aria-controls="nearby" aria-selected="true">
                            <i class="fas fa-map-marker-alt me-2"></i>Nearby Khakis
                            <span class="badge bg-primary ms-2" id="nearbyCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="all-tab" data-bs-toggle="tab" 
                                data-bs-target="#all" type="button" role="tab" 
                                aria-controls="all" aria-selected="false">
                            <i class="fas fa-globe me-2"></i>All Khakis
                            <span class="badge bg-secondary ms-2" id="allCount">0</span>
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="khakiTabContent">
                    <!-- Nearby Khakis Tab -->
                    <div class="tab-pane fade show active" id="nearby" role="tabpanel" 
                         aria-labelledby="nearby-tab">
                        <div id="nearbyKhakisContainer" class="row">
                            <!-- Nearby khakis will be loaded here -->
                        </div>
                    </div>

                    <!-- All Khakis Tab -->
                    <div class="tab-pane fade" id="all" role="tabpanel" aria-labelledby="all-tab">
                        <div id="allKhakisContainer" class="row">
                            <!-- All khakis will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/header.js"></script>
    <script>
        let currentUser = null;
        let nearbyKhakis = [];
        let allKhakis = [];

        // Wait for AuthManager to be available
        function waitForAuthManager() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;

                function checkAuthManager() {
                    attempts++;
                    if (window.AuthManager && 
                        typeof window.AuthManager.initialize === 'function' &&
                        typeof window.AuthManager.checkAuthentication === 'function') {
                        resolve(window.AuthManager);
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('AuthManager not available after timeout'));
                    } else {
                        setTimeout(checkAuthManager, 100);
                    }
                }
                checkAuthManager();
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const authManager = await waitForAuthManager();
                await authManager.initialize();

                const isAuthenticated = await authManager.checkAuthentication();
                if (!isAuthenticated) {
                    window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }

                currentUser = authManager.getCurrentUser();
                
                // Check if user is a senior
                if (currentUser.role !== 'senior') {
                    showErrorMessage('Only seniors can access this page');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                    return;
                }

                // Display current location (convert postal code to area name)
                const areaName = getAreaFromPostalCode(currentUser.location);
                document.getElementById('currentLocation').textContent = areaName;

                // Load khakis data
                await loadKhakis();

                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';

            } catch (error) {
                console.error('Page initialization error:', error);
                showErrorMessage('Failed to load page. Please try again.');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });

        // Load khakis data
        async function loadKhakis() {
            try {
                const authManager = await waitForAuthManager();

                // Load nearby khakis
                const nearbyResponse = await authManager.authenticatedFetch(
                    'http://localhost:5001/khakis?nearby=true'
                );
                const nearbyData = await nearbyResponse.json();

                if (nearbyResponse.ok) {
                    nearbyKhakis = nearbyData.khakis || [];
                    displayKhakis(nearbyKhakis, 'nearbyKhakisContainer');
                    document.getElementById('nearbyCount').textContent = nearbyKhakis.length;
                } else {
                    throw new Error(nearbyData.error || 'Failed to load nearby khakis');
                }

                // Load all khakis
                const allResponse = await authManager.authenticatedFetch(
                    'http://localhost:5001/khakis?nearby=false'
                );
                const allData = await allResponse.json();

                if (allResponse.ok) {
                    allKhakis = allData.khakis || [];
                    displayKhakis(allKhakis, 'allKhakisContainer');
                    document.getElementById('allCount').textContent = allKhakis.length;
                } else {
                    throw new Error(allData.error || 'Failed to load all khakis');
                }

            } catch (error) {
                console.error('Error loading khakis:', error);
                showErrorMessage('Failed to load khakis. Please try again.');
            }
        }

        // Convert Singapore postal code to area name
        function getAreaFromPostalCode(postalCode) {
            if (!postalCode) return 'Location not set';
            
            // Remove any non-digit characters
            const postal = postalCode.toString().replace(/\D/g, '');
            if (postal.length < 2) return 'Unknown Area';
            
            // Get the first 2 digits (sector code)
            const sector = parseInt(postal.substring(0, 2));
            
            // Map Singapore postal sectors to area names
            // Based on actual Singapore postal code ranges
            const sectorMap = {
                // Central (01-09)
                1: 'Raffles Place', 2: 'Tanjong Pagar', 3: 'Tiong Bahru', 
                4: 'Telok Blangah', 5: 'Pasir Panjang', 6: 'High Street', 
                7: 'Beach Road', 8: 'Little India', 9: 'Orchard',
                
                // Central/South (10-16)
                10: 'Tanglin', 11: 'Novena', 12: 'Toa Payoh', 
                13: 'Macpherson', 14: 'Geylang', 15: 'Katong',
                16: 'Bedok', 17: 'Changi',
                
                // East (18-23)
                18: 'Pasir Ris', 19: 'Serangoon Garden', 20: 'Hougang',
                21: 'Upper Serangoon', 22: 'Sengkang', 23: 'Punggol',
                
                // North (24-28)
                24: 'Lim Chu Kang', 25: 'Kranji', 26: 'Upper Thomson',
                27: 'Yishun', 28: 'Seletar',
                
                // Central/North (29-33)
                29: 'Sembawang', 30: 'Mandai', 31: 'Toa Payoh',
                32: 'Toa Payoh', 33: 'Toa Payoh',
                
                // North/West (34-42)
                34: 'Springleaf', 35: 'Woodlands', 36: 'Woodlands',
                37: 'Woodlands', 38: 'Woodlands', 39: 'Woodlands',
                40: 'Choa Chu Kang', 41: 'Choa Chu Kang', 42: 'Bukit Batok',
                
                // West (43-52)
                43: 'Bukit Batok', 44: 'Bukit Batok', 45: 'Bukit Batok',
                46: 'Clementi', 47: 'Clementi', 48: 'Jurong East',
                49: 'Jurong East', 50: 'Jurong West', 51: 'Jurong West',
                52: 'Jurong West',
                
                // Central/West (53-61)
                53: 'Bukit Merah', 54: 'Bukit Merah', 55: 'Queenstown',
                56: 'Ang Mo Kio', 57: 'Ang Mo Kio', 58: 'Bishan',
                59: 'Serangoon', 60: 'Bishan', 61: 'Upper Bukit Timah',
                
                // Central/South (62-68)
                62: 'Alexandra', 63: 'Bukit Merah', 64: 'Harbourfront',
                65: 'Buona Vista', 66: 'Pasir Panjang', 67: 'High Street',
                68: 'Beach Road',
                
                // East (69-82)
                69: 'Rochor', 70: 'Kallang', 71: 'Geylang',
                72: 'Paya Lebar', 73: 'Marine Parade', 74: 'Bedok',
                75: 'Simei', 76: 'Tampines', 77: 'Pasir Ris',
                78: 'Pasir Ris', 79: 'Tampines', 80: 'Tampines',
                81: 'Changi', 82: 'Changi'
            };
            
            return sectorMap[sector] || 'Unknown Area';
        }

        // Display khakis
        function displayKhakis(khakis, containerId) {
            const container = document.getElementById(containerId);

            if (!khakis || khakis.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>No Khakis Found</h4>
                            <p class="text-muted">
                                ${containerId === 'nearbyKhakisContainer' 
                                    ? 'There are no other seniors in your area yet.' 
                                    : 'No seniors are registered in the system yet.'}
                            </p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = khakis.map(khaki => {
                const displayName = khaki.firstname && khaki.lastname 
                    ? `${khaki.firstname} ${khaki.lastname}`
                    : khaki.email;
                
                const memberSince = new Date(khaki.created_at).toLocaleDateString('en-SG', {
                    year: 'numeric',
                    month: 'short'
                });

                // Convert rating to number and ensure it's valid
                const rating = khaki.rating ? parseFloat(khaki.rating) : 5.0;
                const ratingStars = generateRatingStars(rating);

                // Get area name from postal code
                const areaName = getAreaFromPostalCode(khaki.location);
                
                // Show area only in "All Khakis" tab
                const showArea = containerId === 'allKhakisContainer';

                return `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card khaki-card h-100">
                            <div class="khaki-card-header text-center">
                                <img src="${khaki.picture}" alt="${displayName}" class="khaki-avatar mb-2">
                                <h5 class="mb-0">${escapeHtml(displayName)}</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <div class="rating-stars">
                                        ${ratingStars}
                                        <span class="text-dark ms-1">${rating.toFixed(1)}</span>
                                    </div>
                                </div>
                                ${showArea ? `
                                <div class="mb-2">
                                    <span class="location-badge">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        ${escapeHtml(areaName)}
                                    </span>
                                </div>
                                ` : ''}
                                <div class="mb-2">
                                    <i class="fas fa-envelope text-muted me-2"></i>
                                    <small class="text-muted">${escapeHtml(khaki.email)}</small>
                                </div>
                                <div class="member-since">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    Member since ${memberSince}
                                </div>
                            </div>
                            <div class="card-footer bg-white">
                                <button class="btn btn-sm btn-primary w-100" 
                                        onclick="viewProfile(${khaki.id})">
                                    <i class="fas fa-user me-1"></i>View Profile
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Generate rating stars
        function generateRatingStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            let stars = '';
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            return stars;
        }

        // View profile
        function viewProfile(khakiId) {
            // For now, show an alert. You can implement a profile view page later
            showInfoMessage('Profile view feature coming soon!');
            // Future implementation:
            // window.location.href = `profile-view.html?userId=${khakiId}`;
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccessMessage(message) {
            showMessage(message, 'success', 'fa-check-circle');
        }

        function showErrorMessage(message) {
            showMessage(message, 'danger', 'fa-exclamation-triangle');
        }

        function showInfoMessage(message) {
            showMessage(message, 'info', 'fa-info-circle');
        }

        function showMessage(message, type, icon) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 1055; min-width: 300px; max-width: 500px;';
            alert.innerHTML = `
                <i class="fas ${icon} me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
