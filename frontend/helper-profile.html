<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helper Profile - KampungConnect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .helper-profile-card {
            max-width: 800px;
            margin: 0 auto;
        }
        .rating-badge {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: #000;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }
        .rating-stars {
            color: #ffc107;
            font-size: 1.1rem;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
        }
        .stat-item {
            text-align: center;
            padding: 1rem;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        .rating-distribution {
            max-width: 400px;
        }
        .progress-custom {
            height: 8px;
            border-radius: 4px;
        }
        .review-card {
            border-left: 4px solid #ffc107;
            background: #fff;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .reviewer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard.html">
                <i class="fas fa-home me-2"></i>KampungConnect
            </a>
            <div class="ms-auto">
                <a href="/dashboard.html" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <div class="helper-profile-card">
            <!-- Helper Header -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <img id="helperAvatar" src="" class="rounded-circle me-3" width="80" height="80" alt="Helper">
                                <div>
                                    <h3 class="mb-1" id="helperName">Loading...</h3>
                                    <p class="text-muted mb-2" id="helperRole">Community Volunteer</p>
                                    <div class="d-flex align-items-center">
                                        <span class="rating-badge me-3" id="overallRating">5.0</span>
                                        <div class="rating-stars" id="ratingStars">
                                            ★★★★★
                                        </div>
                                        <span class="text-muted ms-2" id="totalRatings">(0 reviews)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="stats-card">
                                <div class="row">
                                    <div class="col-6 stat-item">
                                        <span class="stat-number" id="completedTasks">0</span>
                                        <small>Completed Tasks</small>
                                    </div>
                                    <div class="col-6 stat-item">
                                        <span class="stat-number" id="memberSince">2024</span>
                                        <small>Member Since</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rating Distribution -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Rating Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div class="rating-distribution mx-auto">
                        <div class="row align-items-center mb-2" id="rating5">
                            <div class="col-2">5 ★</div>
                            <div class="col-8">
                                <div class="progress progress-custom">
                                    <div class="progress-bar bg-success" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="col-2 text-end">0</div>
                        </div>
                        <div class="row align-items-center mb-2" id="rating4">
                            <div class="col-2">4 ★</div>
                            <div class="col-8">
                                <div class="progress progress-custom">
                                    <div class="progress-bar bg-info" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="col-2 text-end">0</div>
                        </div>
                        <div class="row align-items-center mb-2" id="rating3">
                            <div class="col-2">3 ★</div>
                            <div class="col-8">
                                <div class="progress progress-custom">
                                    <div class="progress-bar bg-warning" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="col-2 text-end">0</div>
                        </div>
                        <div class="row align-items-center mb-2" id="rating2">
                            <div class="col-2">2 ★</div>
                            <div class="col-8">
                                <div class="progress progress-custom">
                                    <div class="progress-bar bg-danger" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="col-2 text-end">0</div>
                        </div>
                        <div class="row align-items-center" id="rating1">
                            <div class="col-2">1 ★</div>
                            <div class="col-8">
                                <div class="progress progress-custom">
                                    <div class="progress-bar bg-danger" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="col-2 text-end">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Reviews -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>Recent Reviews
                    </h5>
                </div>
                <div class="card-body">
                    <div id="reviewsList">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Loading reviews...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        // Initialize page
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await window.AuthManager.initialize();
                const isAuthenticated = await window.AuthManager.checkAuthentication();
                if (!isAuthenticated) {
                    window.location.href = '/login.html';
                    return;
                }

                // Get helper ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const helperId = urlParams.get('helperId');
                
                if (helperId) {
                    await loadHelperProfile(helperId);
                } else {
                    alert('Helper ID not provided');
                    window.location.href = '/dashboard.html';
                }

            } catch (error) {
                console.error('Failed to initialize:', error);
            }
        });

        async function loadHelperProfile(helperId) {
            try {
                const response = await window.AuthManager.authenticatedFetch(
                    `http://localhost:5006/api/ratings/helper-profile/${helperId}`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    displayHelperProfile(data);
                } else {
                    throw new Error('Failed to load helper profile');
                }
            } catch (error) {
                console.error('Error loading helper profile:', error);
                document.getElementById('reviewsList').innerHTML = 
                    '<div class="alert alert-danger">Failed to load helper profile</div>';
            }
        }

        function displayHelperProfile(data) {
            const { helper, ratings, recentReviews } = data;

            // Update helper info
            document.getElementById('helperName').textContent = helper.name;
            document.getElementById('helperRole').textContent = helper.role;
            document.getElementById('completedTasks').textContent = helper.completedTasks;
            document.getElementById('memberSince').textContent = new Date(helper.memberSince).getFullYear();

            // Update avatar
            const avatarUrl = helper.picture || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(helper.name)}&background=6c757d&color=fff`;
            document.getElementById('helperAvatar').src = avatarUrl;

            // Update ratings
            document.getElementById('overallRating').textContent = ratings.average;
            document.getElementById('totalRatings').textContent = `(${ratings.total} reviews)`;
            
            // Update star display
            const starRating = Math.round(parseFloat(ratings.average));
            const starsHtml = '★'.repeat(starRating) + '☆'.repeat(5 - starRating);
            document.getElementById('ratingStars').textContent = starsHtml;

            // Update rating distribution
            const total = ratings.total || 1; // Avoid division by zero
            for (let i = 1; i <= 5; i++) {
                const count = ratings.distribution[i] || 0;
                const percentage = (count / total) * 100;
                
                const ratingElement = document.getElementById(`rating${i}`);
                const progressBar = ratingElement.querySelector('.progress-bar');
                const countElement = ratingElement.querySelector('.col-2.text-end');
                
                progressBar.style.width = `${percentage}%`;
                countElement.textContent = count;
            }

            // Display recent reviews
            displayRecentReviews(recentReviews);
        }

        function displayRecentReviews(reviews) {
            const reviewsList = document.getElementById('reviewsList');
            
            if (reviews.length === 0) {
                reviewsList.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No reviews yet</p>
                    </div>
                `;
                return;
            }

            reviewsList.innerHTML = reviews.map(review => `
                <div class="review-card">
                    <div class="d-flex align-items-start">
                        <div class="reviewer-avatar me-3">
                            ${review.reviewer.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>${review.reviewer}</strong>
                                <div>
                                    <span class="text-warning me-2">${'★'.repeat(review.score)}${'☆'.repeat(5 - review.score)}</span>
                                    <small class="text-muted">${formatDate(review.date)}</small>
                                </div>
                            </div>
                            <p class="mb-0">${review.comment}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return date.toLocaleDateString();
        }
    </script>
</body>
</html>